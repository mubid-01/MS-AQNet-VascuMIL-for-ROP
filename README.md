# Context-Aware Asymmetric Ensembling for ROP Screening

**Official PyTorch Implementation**

> **Paper Title:** *Context-Aware Asymmetric Ensembling: Integrating Active Query Mechanisms and Vascular Multiple Instance Learning for Interpretable Retinopathy of Prematurity Screening*

---

## 1. Introduction & Motivation

Retinopathy of Prematurity (ROP) is a leading cause of childhood blindness. Automated screening is complicated by the dual nature of the disease:
1.  **Global Structural Anomalies:** Ridges, demarcation lines, and detachments (Stage-based disease).
2.  **Local Micro-Vascular Irregularities:** Arteriolar tortuosity and venous dilation (Plus disease).

Standard Deep Learning approaches often fail on ROP datasets due to **extreme class imbalance**, **limited sample sizes**, and **resolution trade-offs** (downsizing destroys vascular details). Furthermore, most models are "Black Boxes" that ignore critical clinical priors like Gestational Age (GA) and Birth Weight (BW).

### Our Solution: The Asymmetric Ensemble
We propose a novel framework that decouples the diagnostic task into two specialized streams using a **"Resolution Bifurcation"** strategy:

*   **Structure Stream (MS-AQNet):** Operates on global images ($384 \times 384$). Features a novel **Active Query Mechanism** where clinical metadata explicitly "queries" visual feature maps to localize risk-relevant structural pathology.
*   **Texture Stream (VascuMIL):** Operates on high-resolution ($768 \times 768$) patch bags. Utilizes **Vascular Topology Maps (VMAP)** and **Gated Attention MIL** to detect micro-vascular Plus Disease independent of clinical history.

**Key Results (N=188):**
*   **Macro F1 (Diagnosis):** 0.93
*   **ROC AUC (Plus Disease):** 0.999
*   **Severe ROP Sensitivity:** 96.3%

---

## 2. Methodology Overview

### Phase A: Intelligent Data Engineering
We employ a rigorous preprocessing pipeline to standardize data from heterogeneous devices (Clarity, Natus, Phoenix):
*   **Morphological Erosion:** Removes circular aperture artifacts.
*   **Vascular Topology Extraction:** Generates VMAPs using Frangi filters on the Green channel.
*   **4-Channel Stacking:** RGB patches are concatenated depth-wise with VMAPs to enforce geometric awareness in the CNN.

### Phase B: The Structure Specialist (MS-AQNet)
*   **Backbone:** EfficientNet-B0 with **Frozen Batch Normalization** (to stabilize small-batch training).
*   **Active Query:** Clinical metadata is projected into a latent vector that computes spatial attention maps via dot-product similarity.
*   **FiLM Modulation:** Global features are scaled and shifted based on patient risk profiles.

### Phase C: The Texture Specialist (VascuMIL)
*   **Architecture:** Multiple Instance Learning (MIL) with Gated Attention (Ilse et al.).
*   **Input:** Bags of 24 high-resolution patches ($224 \times 224$).
*   **Mechanism:** Assigns attention scores to "sick" patches (tortuosity) while suppressing background noise.

---

## 3. Dataset

This project utilizes the public dataset: **"Retinal Image Dataset of Infants and Retinopathy of Prematurity"** (*Timkovič et al., Scientific Data 2024*).

### Setup
1.  Download the dataset.
2.  Ensure your directory structure looks like this:

```text
/data_root
├── images_stack_without_captions/  # Contains raw .jpg images
├── splits_balanced/                # Generated by our split script
│   ├── fold_0/
│   │   ├── train.csv
│   │   └── val.csv
│   └── test.csv
└── mil_dataset_fold0/              # Generated by our extractor script
    ├── images/                     # Cached patches
    └── metadata/                   # Patch CSVs
